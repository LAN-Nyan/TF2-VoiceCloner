name: Build Multi-Platform Executables
on:
  push:
    branches:
      - main  # Trigger the build when code is pushed to the 'main' branch
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab

jobs:
  build_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install minimal dependencies for building
        run: |
          pip install pyinstaller
          pip install PyQt6
      
      - name: â¬‡ï¸ Download and Setup FFmpeg
        run: |
          mkdir -p $env:RUNNER_TEMP\ffmpeg
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full.7z"
          $output = "$env:RUNNER_TEMP\ffmpeg\ffmpeg.7z"
          Invoke-WebRequest -Uri $url -OutFile $output
          7z x $output -o"$env:RUNNER_TEMP\ffmpeg" -r -y
          $ffmpeg_folder = Get-ChildItem "$env:RUNNER_TEMP\ffmpeg" | Where-Object { $_.PSIsContainer -and $_.Name -like "ffmpeg-*" }
          echo "FFMPEG_BIN_PATH=$($ffmpeg_folder.FullName)\bin" >> $env:GITHUB_ENV
        shell: powershell
      
      - name: Build with PyInstaller (Lightweight)
        run: |
          # Build only with PyQt6, letting the app install ML libs at runtime
          pyinstaller --onefile --windowed --name "TF2VoiceEditor-Windows" `
            --collect-all PyQt6 `
            --add-binary "${{ env.FFMPEG_BIN_PATH }}\ffmpeg.exe;." `
            --add-binary "${{ env.FFMPEG_BIN_PATH }}\ffprobe.exe;." `
            --hidden-import "PyQt6.QtCore" `
            --hidden-import "PyQt6.QtGui" `
            --hidden-import "PyQt6.QtWidgets" `
            tf2_voice_editor.py
        shell: powershell
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TF2VoiceEditor-Windows
          path: dist/TF2VoiceEditor-Windows.exe

  build_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install minimal dependencies for building
        run: |
          pip install pyinstaller
          pip install PyQt6
      
      - name: Install FFmpeg via Homebrew
        run: |
          brew install ffmpeg
          echo "FFMPEG_BIN_PATH=$(which ffmpeg | xargs dirname)" >> $GITHUB_ENV
      
      - name: Build with PyInstaller (Lightweight)
        run: |
          # Build only with PyQt6, letting the app install ML libs at runtime
          pyinstaller --onefile --windowed --name "TF2VoiceEditor-macOS" \
            --collect-all PyQt6 \
            --add-binary "$FFMPEG_BIN_PATH/ffmpeg:." \
            --add-binary "$FFMPEG_BIN_PATH/ffprobe:." \
            --hidden-import "PyQt6.QtCore" \
            --hidden-import "PyQt6.QtGui" \
            --hidden-import "PyQt6.QtWidgets" \
            tf2_voice_editor.py
      
      - name: Create DMG
        run: |
          # Create a simple DMG for distribution
          mkdir -p dist/dmg
          cp -r "dist/TF2VoiceEditor-macOS.app" dist/dmg/
          # Create Applications symlink for easy drag-and-drop
          ln -s /Applications dist/dmg/Applications
          hdiutil create -volname "TF2VoiceEditor" -srcfolder dist/dmg -ov -format UDZO dist/TF2VoiceEditor-macOS.dmg
      
      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: TF2VoiceEditor-macOS-app
          path: dist/TF2VoiceEditor-macOS.app
      
      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: TF2VoiceEditor-macOS-dmg
          path: dist/TF2VoiceEditor-macOS.dmg

  create_release:
    needs: [build_windows, build_macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ðŸŽ® TF2 Voice Line Editor
          
          ### âœ¨ What's New
          - **ðŸš€ Auto Package Install**: Revolutionary first-run setup! The app automatically downloads and installs all AI dependencies (torch, F5-TTS, etc.) with a beautiful progress dialog. No manual installation needed!
          - ðŸŽ¤ AI-powered voice cloning using F5-TTS
          - ðŸ” Smart audio file transcription with Vosk
          - ðŸŽµ Audio clip combination and editing
          - ðŸŽ¨ Modern dark-themed TF2-inspired interface
          - ðŸ“‚ Bulk directory scanning for audio files
          
          ### ðŸ“¥ Installation
          
          #### Windows
          1. Download `TF2VoiceEditor-Windows.exe` (~150MB)
          2. Double-click to run
          3. **First launch**: The app will show an installer dialog and automatically download ~2GB of AI packages (torch, F5-TTS, vosk, etc.). This takes 5-10 minutes depending on your internet speed
          4. Subsequent launches are instant!
          
          #### macOS
          1. Download `TF2VoiceEditor-macOS.dmg` (~150MB)
          2. Open the DMG and drag the app to Applications
          3. Right-click the app â†’ "Open" (required for first run due to macOS Gatekeeper)
          4. **First launch**: The app will show an installer dialog and automatically download ~2GB of AI packages. This takes 5-10 minutes
          5. Subsequent launches are instant!
          
          > ðŸ’¡ **Tip**: Make sure you have a stable internet connection for the first launch!
          
          ### ðŸŽ¯ Features
          - ðŸ“‚ **Smart Scanning**: Automatically detect TF2 characters from file paths
          - ðŸ”Ž **Powerful Search**: Filter by transcript text and character
          - ðŸŽ™ï¸ **AI Voice Generation**: Clone any TF2 voice with reference audio
          - ðŸŽ¼ **Clip Combining**: Merge multiple audio files seamlessly
          - ðŸ’¾ **Export**: Save as high-quality WAV files
          - ðŸŽ¨ **TF2-Themed UI**: Beautiful gradient interface inspired by Team Fortress 2
          
          ### ðŸ’» System Requirements
          - **Windows**: Windows 10/11 (64-bit)
          - **macOS**: macOS 11 (Big Sur) or later (Intel or Apple Silicon)
          - **RAM**: 8GB minimum, 16GB recommended for AI features
          - **Disk Space**: 
            - Initial download: ~150MB
            - First-run install: ~2GB for AI packages
            - Runtime: Additional space for audio files
          - **Internet**: Required for first-run package installation
          
          ### ðŸ”§ Technical Details
          - Built with PyQt6 for native UI
          - Uses F5-TTS for voice cloning
          - Vosk for speech transcription
          - PyDub for audio processing
          - FFmpeg included for format conversion
          
          ### âš ï¸ Known Issues
          - **First launch requires internet** and takes 5-10 minutes for package installation
          - AI voice generation is computationally intensive (may be slow on older systems)
          - macOS users must right-click â†’ "Open" on first launch due to app signing
          - Some antivirus software may flag the exe (false positive - the app is safe)
          
          ### ðŸ› Troubleshooting
          
          **"App won't open" (macOS)**
          - Right-click â†’ "Open" instead of double-clicking
          - Go to System Preferences â†’ Security & Privacy and click "Open Anyway"
          
          **"Installation failed"**
          - Check your internet connection
          - Make sure you have ~2GB free disk space
          - Try running as administrator (Windows) or with appropriate permissions (macOS)
          
          **"App is slow"**
          - AI features require significant RAM and CPU
          - Close other applications
          - First-time AI operations may take longer
          
          ### ðŸ’¬ Support
          Found a bug? Have a feature request? Open an issue on GitHub!
          
          ---
          
          **Made with â¤ï¸ for the TF2 community**
          EOF
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Zip macOS app for release
        run: |
          cd artifacts/TF2VoiceEditor-macOS-app
          zip -r ../../TF2VoiceEditor-macOS.app.zip .
          cd ../..
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0-${{ steps.date.outputs.date }}
          name: "ðŸŽ® TF2 Voice Editor v1.0.0 - Auto-Install Edition"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/TF2VoiceEditor-Windows/TF2VoiceEditor-Windows.exe
            artifacts/TF2VoiceEditor-macOS-dmg/TF2VoiceEditor-macOS.dmg
            TF2VoiceEditor-macOS.app.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
