name: Build Windows Executable

on:
  push:
    branches:
      - main  # Trigger the build when code is pushed to the 'main' branch
  workflow_dispatch: # Allows manual trigger from the GitHub Actions tab

jobs:
  build_exe:
    runs-on: windows-latest # Use a fresh Windows server environment

    steps:
      - uses: actions/checkout@v4 # Step 1: Clone the repository

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' 

      - name: Install Python dependencies
        run: |
          # Install PyInstaller
          pip install pyinstaller
          # Install core dependencies
          pip install PyQt6 f5-tts torch torchaudio soundfile pydub vosk requests

      - name: ⬇️ Download and Setup FFmpeg
        # FFmpeg is an external binary required by pydub for audio operations.
        # This step downloads and extracts it, then sets an environment variable to its path.
        run: |
          # Create a temporary directory for FFmpeg
          mkdir -p $env:RUNNER_TEMP\ffmpeg
          
          # Download the FFmpeg release for Windows
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full.7z"
          $output = "$env:RUNNER_TEMP\ffmpeg\ffmpeg.7z"
          Invoke-WebRequest -Uri $url -OutFile $output
          
          # Unzip (7-Zip is pre-installed on GitHub Windows runners)
          7z x $output -o"$env:RUNNER_TEMP\ffmpeg" -r -y
          
          # Find the actual extracted folder name (it changes with versions)
          $ffmpeg_folder = Get-ChildItem "$env:RUNNER_TEMP\ffmpeg" | Where-Object { $_.PSIsContainer -and $_.Name -like "ffmpeg-*" }
          
          # Define environment variable pointing to the bin folder
          echo "FFMPEG_BIN_PATH=$($ffmpeg_folder.FullName)\bin" >> $env:GITHUB_ENV
        shell: powershell

      - name: Build with PyInstaller
        # NOTE: The backtick (`) is used for line continuation in PowerShell.
        # The vosk path now uses the reliable env.pythonLocation variable.
        run: |
          pyinstaller --windowed --name "TF2VoiceCloner" `
            --collect-all torch `
            --collect-all f5_tts `
            --collect-all vosk `
            --collect-all pydub `
            --hidden-import "torch.nn.intrinsic.qat" `
            --add-binary "${{ env.FFMPEG_BIN_PATH }}\ffmpeg.exe;." `
            --add-binary "${{ env.FFMPEG_BIN_PATH }}\ffprobe.exe;." `
            --add-data "${{ env.pythonLocation }}\Lib\site-packages\vosk\__init__.py;vosk" `
            tf2_voice_editor.py
        shell: powershell
